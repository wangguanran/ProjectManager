name: Publish Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write
  actions: read
  packages: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y patchelf binutils git

      - name: Build project
        shell: bash
        run: bash build.sh

      - name: Run tests
        shell: bash
        run: bash -lc "source venv/bin/activate && pytest"

      - name: Run lint
        shell: bash
        run: bash -lc "source venv/bin/activate && make lint"

  build-binaries:
    name: build-binaries (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y patchelf binutils

      - name: Build project
        shell: bash
        run: bash build.sh

      - name: Collect binary artifact
        id: binary
        shell: bash
        run: |
          set -euo pipefail
          binary_src=""
          if [ -f out/projman_binary_path.txt ]; then
            from_manifest="$(cat out/projman_binary_path.txt)"
            if [ -n "$from_manifest" ] && [ -e "$from_manifest" ]; then
              binary_src="$from_manifest"
            fi
          fi
          if [ -z "$binary_src" ]; then
            binary_src="$(find out \( -type f -o -type l \) \( -name 'projman' -o -name 'projman.exe' \) | sort | head -n1 || true)"
          fi
          if [ -z "$binary_src" ]; then
            echo "No projman binary found under out/" >&2
            find out -maxdepth 5 \( -type f -o -type l \) | sed 's#^#  - #' >&2 || true
            exit 1
          fi
          mkdir -p out/release
          binary_dst="out/release/$(basename "$binary_src")"
          cp -L "$binary_src" "$binary_dst"
          echo "binary_path=$binary_dst" >> "$GITHUB_OUTPUT"

      - name: Compute artifact metadata
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          uname_s="$(uname -s 2>/dev/null || echo unknown)"
          case "$uname_s" in
            Linux) platform="linux" ;;
            Darwin) platform="macos" ;;
            MINGW*|MSYS*|CYGWIN*|Windows_NT) platform="windows" ;;
            *) platform="unknown" ;;
          esac
          arch="$(uname -m 2>/dev/null || echo unknown)"
          case "$arch" in
            x86_64|amd64) arch="x86_64" ;;
            aarch64|arm64) arch="arm64" ;;
          esac
          echo "platform=$platform" >> "$GITHUB_OUTPUT"
          echo "arch=$arch" >> "$GITHUB_OUTPUT"

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: projman-${{ steps.meta.outputs.platform }}-${{ steps.meta.outputs.arch }}
          if-no-files-found: error
          path: ${{ steps.binary.outputs.binary_path }}

  release:
    runs-on: ubuntu-latest
    needs: [test, build-binaries]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Create release assets
      shell: bash
      run: |
        set -euo pipefail
        mkdir -p release

        for dir in artifacts/projman-*; do
          [ -d "$dir" ] || continue
          name="$(basename "$dir")"
          bin="$(find "$dir" -type f \( -name 'projman' -o -name 'projman.exe' \) | sort | head -n1 || true)"
          if [ -z "$bin" ]; then
            echo "No binary found under $dir" >&2
            exit 1
          fi

          ext=""
          case "$bin" in
            *.exe) ext=".exe" ;;
          esac

          cp "$bin" "release/${name}${ext}"
          sha256sum "release/${name}${ext}" > "release/${name}${ext}.sha256"
        done

        # Create release notes
        cat > release/RELEASE_NOTES.md << EOF
        # ProjectManager (projman) Release

        ## Install (Linux/macOS)

        \`\`\`bash
        curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/${{ github.ref_name }}/get_latest_release.sh | bash
        projman --version
        \`\`\`

        ## Install (Windows)

        \`\`\`powershell
        iwr -useb https://raw.githubusercontent.com/${{ github.repository }}/${{ github.ref_name }}/install.ps1 | iex
        projman --version
        \`\`\`

        ## Assets

        - projman-linux-<arch>
        - projman-macos-<arch>
        - projman-windows-<arch>.exe

        ## Checksum
        Verify the download with the provided SHA256 checksum.
        EOF
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release/projman-*
        body_path: release/RELEASE_NOTES.md
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 

  publish-pypi:
    name: publish-pypi
    runs-on: ubuntu-latest
    needs: release
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Check PyPI token configured
        env:
          PYPI_API_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          if [ -z "${PYPI_API_TOKEN:-}" ]; then
            echo "PYPI_API_TOKEN is not configured." >&2
            exit 1
          fi

      - name: Build package
        run: |
          python scripts/write_build_info.py
          python -m build

      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          python -m twine upload --repository-url https://upload.pypi.org/legacy/ dist/*

  publish-docker:
    name: publish-docker
    runs-on: ubuntu-latest
    needs: release
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=raw,value=latest
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=ref,event=branch
            type=sha,prefix=sha-

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
