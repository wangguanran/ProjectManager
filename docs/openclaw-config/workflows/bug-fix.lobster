name: bug-fix
description: "Bug ä¿®å¤æµç¨‹ï¼šå¤ç° -> ä¿®å¤ -> éªŒè¯"

args:
  bug_description:
    description: "Bug æè¿°"
    required: true
  test_case_id:
    description: "æµ‹è¯•ç”¨ä¾‹ ID"
    required: true
  project_path:
    description: "é¡¹ç›®æ ¹ç›®å½•"
    default: "/home/wangguanran/ProjectManager"

env:
  PYTHONPATH: "$args.project_path/src"
  PROJECT_ROOT: "$args.project_path"

steps:
  # é˜¶æ®µ 1: Bug å¤ç°
  - id: reproduce
    command: |
      openclaw.invoke --tool sessions_spawn --action spawn \
        --args-json '{
          "task": "å¤ç° Bug: $args.bug_descriptionã€‚æŒ‰ç…§æµ‹è¯•ç”¨ä¾‹ $args.test_case_id æ‰§è¡Œã€‚",
          "label": "bug-reproduce",
          "agentId": "tester",
          "runTimeoutSeconds": 300
        }'

  # é˜¶æ®µ 2: æ ¹å› åˆ†æ
  - id: analyze
    command: |
      openclaw.invoke --tool sessions_spawn --action spawn \
        --args-json '{
          "task": "åˆ†æ Bug æ ¹å› : $args.bug_descriptionã€‚å®šä½é—®é¢˜ä»£ç ä½ç½®ã€‚",
          "label": "root-cause-analysis",
          "agentId": "pm"
        }'
    condition: $reproduce.approved
    approval: required
    prompt: "Bug å·²å¤ç°ã€‚æ˜¯å¦ç»§ç»­æ ¹å› åˆ†æï¼Ÿ"

  # é˜¶æ®µ 3: ä¿®å¤å®æ–½
  - id: fix
    command: |
      openclaw.invoke --tool sessions_spawn --action spawn \
        --args-json '{
          "task": "ä¿®å¤ Bug: $args.bug_descriptionã€‚æ ¹æ®æ ¹å› åˆ†æç»“æœå®æ–½ä¿®å¤ã€‚",
          "label": "bug-fix",
          "agentId": "builder"
        }'
    condition: $analyze.approved
    approval: required
    prompt: "æ ¹å› å·²å®šä½ã€‚æ˜¯å¦å¼€å§‹ä¿®å¤ï¼Ÿ"

  # é˜¶æ®µ 4: å›å½’æµ‹è¯•
  - id: regression_test
    command: |
      cd $args.project_path && \
      python -m pytest tests/ -v --tb=short -k "$args.test_case_id"
    condition: $fix.approved

  # é˜¶æ®µ 5: éªŒè¯é€šè¿‡
  - id: verify
    command: |
      echo "Bug ä¿®å¤éªŒè¯å®Œæˆ"
      echo "æµ‹è¯•ç”¨ä¾‹ $args.test_case_id: PASSED"
    stdin: $regression_test.stdout
    approval: required
    prompt: "å›å½’æµ‹è¯•é€šè¿‡ã€‚æ˜¯å¦ç¡®è®¤ä¿®å¤å®Œæˆï¼Ÿ"

  # é˜¶æ®µ 6: æ›´æ–°æ–‡æ¡£
  - id: update_docs
    command: |
      openclaw.invoke --tool write --action write \
        --args-json '{
          "filePath": "$args.project_path/docs/bugs/fixed-$args.test_case_id.md",
          "content": "# Bug ä¿®å¤è®°å½•\n\n## Bug æè¿°\n$args.bug_description\n\n## æµ‹è¯•ç”¨ä¾‹\n$args.test_case_id\n\n## ä¿®å¤æ—¶é—´\n$(date)\n\n## çŠ¶æ€\nå·²ä¿®å¤å¹¶éªŒè¯"
        }'
    condition: $verify.approved

  # é˜¶æ®µ 7: é€šçŸ¥ç”¨æˆ·
  - id: notify
    command: |
      openclaw.invoke --tool message --action send \
        --args-json '{
          "provider": "whatsapp",
          "to": "+8613800000000",
          "message": "ğŸ› Bug å·²ä¿®å¤\næè¿°: $args.bug_description\næµ‹è¯•ç”¨ä¾‹: $args.test_case_id\nçŠ¶æ€: å·²éªŒè¯é€šè¿‡"
        }'
    condition: $update_docs.approved
