# 系统架构

本文档描述了 ProjectManager 系统的整体架构和设计原则。

## 架构概述

ProjectManager 遵循模块化、基于插件的架构，专为可扩展性和可维护性而设计。系统围绕提供基本功能的核心模块构建，插件为特定用例扩展功能。

## 核心架构组件

### 1. 主应用程序层 (`src/__main__.py`)

**目的**: 入口点和命令编排

**职责**:
- 解析命令行参数
- 将命令路由到适当的模块
- 处理全局错误管理
- 提供用户界面和反馈

**设计模式**: 具有集中路由的命令模式

### 2. 插件系统 (`src/plugins/`)

**目的**: 可扩展功能模块

**组件**:
- **项目管理插件** (`project_manager.py`): 核心项目管理
- **补丁覆盖插件** (`patch_override.py`): 高级文件修改管理

**设计模式**: 具有标准化接口的插件架构

### 3. 工具层 (`src/utils.py`, `src/log_manager.py`, `src/profiler.py`)

**目的**: 共享工具和横切关注点

**组件**:
- **Utils**: 通用辅助函数
- **日志管理器**: 具有可配置级别的集中日志记录
- **性能分析器**: 性能监控和优化

**设计模式**: 具有关注点分离的工具模式

## 数据流架构

### 1. 配置管理流程

```
用户配置文件 (.ini)
           ↓
    配置解析器 (utils.py)
           ↓
    项目管理插件
           ↓
    验证和处理
           ↓
    运行时配置
```

### 2. 仓库发现流程

```
当前目录
           ↓
    仓库扫描器
           ↓
    按忽略模式过滤
           ↓
    仓库列表
           ↓
    文件修改检测
           ↓
    交互式选择
```

### 3. PO（补丁/覆盖）处理流程

```
PO 配置
           ↓
    文件选择和创建
           ↓
    补丁/覆盖生成
           ↓
    应用到仓库
           ↓
    状态跟踪和验证
```

## 模块依赖

### 依赖图

```
src/__main__.py
    ├── src/plugins/project_manager.py
    ├── src/plugins/patch_override.py
    ├── src/utils.py
    ├── src/log_manager.py
    └── src/profiler.py
```

### 模块职责

| 模块 | 主要职责 | 依赖项 |
|------|----------|--------|
| `__main__.py` | 命令编排 | 所有插件、工具、日志管理器 |
| `project_manager.py` | 项目配置 | 工具、日志管理器 |
| `patch_override.py` | 文件修改管理 | 工具、日志管理器、性能分析器 |
| `utils.py` | 通用工具 | 日志管理器 |
| `log_manager.py` | 日志基础设施 | 无 |
| `profiler.py` | 性能监控 | 无 |

## 配置架构

### 1. 项目配置结构

```
projects/
├── board01/
│   ├── board01.ini          # 项目配置
│   └── po/                  # PO 目录
│       ├── po_name1/
│       │   ├── patches/     # Git 补丁
│       │   └── overrides/   # 文件覆盖
│       └── po_name2/
└── board02/
    ├── board02.ini
    └── po/
```

### 2. 配置文件格式

```ini
[project_name]
board_name = board_name
PROJECT_PO_CONFIG = po1 po2 -po3 po4[file1 file2]
PROJECT_PO_IGNORE = vendor/* external/*
```

### 3. 配置验证

- **语法验证**: INI 文件格式检查
- **语义验证**: 配置值验证
- **交叉引用验证**: 主板和 PO 存在性验证

## 仓库管理架构

### 1. 仓库发现策略

**Git 仓库检测**:
- 标准 `.git` 目录检测
- 递归目录扫描
- 基于路径的仓库识别

**Repo 清单支持**:
- Android 风格的 `.repo/manifest.xml` 解析
- 基于 XML 的项目定义
- 多仓库工作空间管理

### 2. 仓库过滤

**忽略模式处理**:
- 基于 fnmatch 的模式匹配
- 增强的路径包含匹配
- 多级过滤（仓库和文件级别）

### 3. 文件修改检测

**Git 集成**:
- 暂存更改检测 (`git diff --cached`)
- 工作目录更改 (`git diff`)
- 未跟踪文件检测 (`git ls-files --others`)

---

## 其他语言版本

- [English Version](architecture_EN.md) - 英文版文档

## PO（补丁/覆盖）架构

### 1. PO 目录结构

```
po/po_name/
├── patches/              # Git 补丁文件
│   ├── repo1/
│   │   ├── file1.patch
│   │   └── file2.patch
│   └── repo2/
│       └── file3.patch
└── overrides/            # 文件覆盖副本
    ├── repo1/
    │   ├── file1
    │   └── file2
    └── repo2/
        └── file3
```

### 2. 补丁生成过程

```
修改文件检测
           ↓
    Git Diff 生成
           ↓
    补丁文件创建
           ↓
    元数据存储
           ↓
    应用跟踪
```

### 3. 覆盖生成过程

```
文件选择
           ↓
    文件复制操作
           ↓
    目录结构创建
           ↓
    元数据存储
           ↓
    应用跟踪
```

## 错误处理架构

### 1. 错误分类

**配置错误**:
- 配置文件中的无效语法
- 缺少必需字段
- 交叉引用验证失败

**运行时错误**:
- 文件系统访问问题
- Git 命令失败
- 网络连接问题

**用户错误**:
- 无效命令参数
- 缺少依赖项
- 权限问题

### 2. 错误恢复策略

**优雅降级**:
- 使用可用数据继续处理
- 跳过有问题的仓库
- 提供详细的错误报告

**回滚机制**:
- 失败时自动清理
- 状态恢复功能
- 类似事务的操作

## 性能架构

### 1. 性能分析集成

**自动性能分析**:
- 函数执行时间测量
- 内存使用跟踪
- 性能瓶颈识别

**手动性能分析**:
- 选择性函数性能分析
- 自定义性能指标
- 详细分析报告

### 2. 优化策略

**缓存**:
- 配置文件缓存
- 仓库发现缓存
- 文件修改状态缓存

**并行处理**:
- 并发仓库扫描
- 并行文件处理
- 批量操作

## 安全架构

### 1. 文件系统安全

**路径验证**:
- 绝对路径预防
- 目录遍历保护
- 符号链接处理

**权限管理**:
- 尽可能的只读操作
- 最小必需权限
- 用户权限验证

### 2. 配置安全

**输入验证**:
- 配置文件清理
- 命令参数验证
- 跨站脚本预防

## 可扩展性架构

### 1. 插件接口设计

**标准化接口**:
- 通用插件基类
- 标准化方法签名
- 配置集成点

**插件发现**:
- 自动插件加载
- 动态插件注册
- 插件依赖管理

### 2. 配置可扩展性

**自定义字段**:
- 用户定义的配置选项
- 插件特定设置
- 环境特定覆盖

**验证扩展**:
- 自定义验证规则
- 插件特定验证
- 跨插件验证

## 测试架构

### 1. 测试组织

**单元测试**:
- 单个模块测试
- 基于模拟的隔离
- 快速执行

**集成测试**:
- 端到端工作流程测试
- 真实文件系统操作
- Git 仓库测试

**性能测试**:
- 负载测试
- 内存使用测试
- 可扩展性验证

### 2. 测试数据管理

**测试仓库**:
- 合成 Git 仓库
- 受控测试场景
- 可重现测试用例

**模拟数据**:
- 配置文件模拟
- 文件系统模拟
- Git 命令模拟

## 部署架构

### 1. 包分发

**Python 包**:
- PyPI 分发
- GitHub Package Registry
- 本地安装支持

**Docker 容器**:
- 多阶段构建
- 最小运行时镜像
- 安全加固

### 2. CI/CD 集成

**自动化测试**:
- GitHub Actions 工作流程
- 多平台测试
- 自动化质量检查

**发布管理**:
- 自动化版本控制
- 发布说明生成
- 资源分发

## 未来架构考虑

### 1. 可扩展性改进

**分布式处理**:
- 多机仓库扫描
- 并行 PO 应用
- 负载平衡策略

**数据库集成**:
- 配置持久化
- 性能指标存储
- 审计跟踪维护

### 2. 高级功能

**Web 界面**:
- RESTful API 设计
- 基于 Web 的配置
- 实时监控

**插件市场**:
- 第三方插件支持
- 插件版本控制
- 依赖解析
